version: '3.8'

services:

  backend:
    build: .
    command: uvicorn executive_api:app --host 0.0.0.0 --port 8000 --reload
    ports:
      version: '3.8'
      services:
        backend:
          build: .
          container_name: discografica_backend
          ports:
            - "8000:8000"
          environment:
            - SUPABASE_URL=${SUPABASE_URL}
            - SUPABASE_KEY=${SUPABASE_KEY}
            - OPENAI_API_KEY=${OPENAI_API_KEY}
          volumes:
            - .:/app
          command: ["python3", "executive_api.py"]

        dashboard:
          build: .
          container_name: discografica_dashboard
          ports:
            - "8501:8501"
          environment:
            - SUPABASE_URL=${SUPABASE_URL}
            - SUPABASE_KEY=${SUPABASE_KEY}
            - OPENAI_API_KEY=${OPENAI_API_KEY}
          volumes:
            - .:/app
          command: ["streamlit", "run", "executive_dashboard.py"]

        telegram_bot:
          build: .
          container_name: discografica_telegram_bot
          environment:
            - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
            - OPENAI_API_KEY=${OPENAI_API_KEY}
          volumes:
            - .:/app
          command: ["python3", "telegram_bot/bot.py"]

        ml_engine:
          build: .
          container_name: discografica_ml_engine
          environment:
            - SUPABASE_URL=${SUPABASE_URL}
            - SUPABASE_KEY=${SUPABASE_KEY}
            - OPENAI_API_KEY=${OPENAI_API_KEY}
          volumes:
            - .:/app
          command: ["python3", "-m", "ml_engine.supabase_connector"]

        supabase:
          image: supabase/postgres:latest
          container_name: discografica_supabase
          ports:
            - "5432:5432"
          environment:
            POSTGRES_PASSWORD: supabase_pw
            POSTGRES_DB: supabase_db
          volumes:
            - supabase_data:/var/lib/postgresql/data

      volumes:
        supabase_data:
